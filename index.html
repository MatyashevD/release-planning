<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WB Drive Release Plan</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    /* ... */
  </style>
</head>
<body>
  <!-- –í–∞—à–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <!-- ... -->

  <script>
  (function(){
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
    const SUPABASE_URL = "https://nfixznxrpiobbstrqvdw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5maXh6bnhycGlvYmJzdHJxdmR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MjA1MDgsImV4cCI6MjA3MTA5NjUwOH0.bTCzAPdX5mDVl8AtbZeefsSFqlPo7c_zebKimn_mCsY";
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        flowType: 'pkce',
        autoRefreshToken: true,
        detectSessionInUrl: true,
        persistSession: true,
        storage: localStorage
      }
    });
    
    const STATUS_ORDER = [
      {id:'ready', label:'Ready to Dev'},
      {id:'dev', label:'–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'},
      {id:'review', label:'Review/QA'},
      {id:'test', label:'–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'},
      {id:'rfr', label:'–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–ª–∏–∑—É'},
      {id:'released', label:'Released'}
    ];

    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    let data = {
      releases: {},
      currentRelease: ""
    };
    
    let chart;
    let editingId = null;
    let currentUser = null;

    // –°–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
    const els = {
      board: document.getElementById('board'),
      search: document.getElementById('search'),
      filterRelease: document.getElementById('filterRelease'),
      addBtn: document.getElementById('addBtn'),
      addReleaseBtn: document.getElementById('addReleaseBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      themeBtn: document.getElementById('themeBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      progressChart: document.getElementById('progressChart'),
      releaseDate: document.getElementById('releaseDate'),
      storeDate: document.getElementById('storeDate'),
      releaseInfo: document.getElementById('releaseInfo'),
      modal: document.getElementById('modal'),
      mTitle: document.getElementById('mTitle'),
      mRelease: document.getElementById('mRelease'),
      mAssignee: document.getElementById('mAssignee'),
      mPriority: document.getElementById('mPriority'),
      mDescription: document.getElementById('mDescription'),
      mLink: document.getElementById('mLink'),
      mTags: document.getElementById('mTags'),
      mSave: document.getElementById('mSave'),
      mCancel: document.getElementById('mCancel'),
      releaseDateDisplay: document.getElementById('releaseDateDisplay'),
      storeDateDisplay: document.getElementById('storeDateDisplay'),
      releaseDays: document.getElementById('releaseDays'),
      storeDays: document.getElementById('storeDays'),
      releaseProgress: document.getElementById('releaseProgress'),
      storeProgress: document.getElementById('storeProgress'),
      kanbanView: document.getElementById('kanbanView'),
      backlogView: document.getElementById('backlogView'),
      loginModal: document.getElementById('loginModal'),
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      loginBtn: document.getElementById('loginBtn'),
      signupBtn: document.getElementById('signupBtn'),
      loginLoader: document.getElementById('loginLoader'),
      loginMessage: document.getElementById('loginMessage')
    };

    // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
    async function checkSession() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) throw error;
        if (session) {
          currentUser = session.user;
          els.loginModal.style.display = 'none';
          els.logoutBtn.style.display = 'block';
          await initApp();
        }
      } catch (error) {
        console.error('Session error:', error);
        showLoginMessage('Session error: ' + error.message);
      }
    }

    function initEventHandlers() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      if (els.loginBtn) els.loginBtn.addEventListener('click', login);
      if (els.signupBtn) els.signupBtn.addEventListener('click', signup);
      if (els.logoutBtn) els.logoutBtn.addEventListener('click', logout);
      
      if (els.loginPassword) {
        els.loginPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') login();
        });
      }
      
      // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –ü–†–ò–í–Ø–ó–ö–ê –ö–ù–û–ü–ö–ò ADD ITEM
      if (els.addBtn) {
        els.addBtn.addEventListener('click', addItem);
        console.log("Add button handler attached");
      }
    }

    async function login() {
      try {
        toggleLoginLoader(true);
        const email = els.loginEmail.value;
        const password = els.loginPassword.value;
        
        if (!email || !password) {
          showLoginMessage('Please enter email and password');
          return;
        }
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        els.loginModal.style.display = 'none';
        els.logoutBtn.style.display = 'block';
        await initApp();
      } catch (error) {
        console.error('Login error:', error);
        showLoginMessage(error.message || 'Login failed');
      } finally {
        toggleLoginLoader(false);
      }
    }

    async function signup() {
      try {
        toggleLoginLoader(true);
        const email = els.loginEmail.value;
        const password = els.loginPassword.value;
        
        if (!email || !password) {
          showLoginMessage('Please enter email and password');
          return;
        }
        
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: window.location.href
          }
        });
        
        if (error) throw error;
        
        if (data.user) {
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
          currentUser = data.user;
          els.loginModal.style.display = 'none';
          els.logoutBtn.style.display = 'block';
          await initApp();
          showLoginMessage('Registration successful!');
        } else {
          showLoginMessage('Check your email for confirmation!');
        }
      } catch (error) {
        console.error('Signup error:', error);
        showLoginMessage(error.message || 'Registration failed');
      } finally {
        toggleLoginLoader(false);
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      els.logoutBtn.style.display = 'none';
      els.loginModal.style.display = 'block';
      data = { releases: {}, currentRelease: "" };
      render();
    }

    function toggleLoginLoader(show) {
      if (els.loginLoader) els.loginLoader.style.display = show ? 'block' : 'none';
      if (els.loginBtn) els.loginBtn.disabled = show;
      if (els.signupBtn) els.signupBtn.disabled = show;
    }

    function showLoginMessage(message) {
      if (els.loginMessage) {
        els.loginMessage.textContent = message;
        setTimeout(() => { els.loginMessage.textContent = ''; }, 5000);
      }
    }

    // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    async function initApp() {
      await loadReleases();
      initReleases();
      render();
      setupRealtime();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ª–∏–∑–æ–≤ –∏–∑ Supabase
    async function loadReleases() {
      const { data: releases, error } = await supabase
        .from('releases')
        .select('*');
      
      if (error) {
        console.error('Error loading releases:', error);
        return;
      }
      
      data.releases = {};
      if (releases) {
        releases.forEach(release => {
          data.releases[release.version] = {
            id: release.id,
            releaseDate: release.release_date,
            storeDate: release.store_date,
            items: []
          };
        });
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ª–∏–∑–æ–≤
      await loadTasks();
      
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–ª–∏–∑–∞
      if (Object.keys(data.releases).length > 0) {
        data.currentRelease = Object.keys(data.releases)[0];
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –∏–∑ Supabase
    async function loadTasks() {
      const { data: tasks, error } = await supabase
        .from('tasks')
        .select('*');
      
      if (error) {
        console.error('Error loading tasks:', error);
        return;
      }
      
      // –°–±—Ä–æ—Å –∑–∞–¥–∞—á
      Object.values(data.releases).forEach(release => {
        release.items = [];
      });
      
      // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ä–µ–ª–∏–∑–∞–º
      if (tasks) {
        tasks.forEach(task => {
          const release = Object.values(data.releases).find(r => r.id === task.release_id);
          if (release) {
            release.items.push({
              id: task.id,
              title: task.title,
              status: task.status,
              assignee: task.assignee,
              priority: task.priority,
              link: task.link,
              description: task.description,
              tags: task.tags || [],
              release: task.release_id
            });
          }
        });
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ª–∏–∑–æ–≤ –≤ UI
    function initReleases() {
      els.filterRelease.innerHTML = '<option value="">Select Release</option>';
      Object.keys(data.releases).forEach(release => {
        const option = document.createElement('option');
        option.value = release;
        option.textContent = release;
        if (release === data.currentRelease) {
          option.selected = true;
        }
        els.filterRelease.appendChild(option);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–ª–∏–∑–∞
      const current = data.releases[data.currentRelease];
      if (current) {
        els.releaseDate.value = current.releaseDate || "";
        els.storeDate.value = current.storeDate || "";
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∞—Ç
    els.releaseDate.onchange = async () => {
      const releaseVersion = data.currentRelease;
      const release = data.releases[releaseVersion];
      if (!release) return;
      
      release.releaseDate = els.releaseDate.value;
      
      await supabase
        .from('releases')
        .update({ release_date: release.releaseDate })
        .eq('version', releaseVersion);
      
      render();
    };
    
    els.storeDate.onchange = async () => {
      const releaseVersion = data.currentRelease;
      const release = data.releases[releaseVersion];
      if (!release) return;
      
      release.storeDate = els.storeDate.value;
      
      await supabase
        .from('releases')
        .update({ store_date: release.storeDate })
        .eq('version', releaseVersion);
      
      render();
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ä–µ–ª–∏–∑–∞
    els.filterRelease.onchange = () => {
      data.currentRelease = els.filterRelease.value;
      render();
    };

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞
    els.addReleaseBtn.addEventListener('click', async () => {
      const version = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.0):");
      if (version) {
        if (!data.releases[version]) {
          // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–∏–∑ –≤ Supabase
          const { data: newRelease, error } = await supabase
            .from('releases')
            .insert({
              version: version,
              release_date: null,
              store_date: null
            })
            .select();
          
          if (error) {
            alert("Error creating release: " + error.message);
            return;
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ
          if (newRelease && newRelease.length > 0) {
            data.releases[version] = {
              id: newRelease[0].id,
              releaseDate: null,
              storeDate: null,
              items: []
            };
            
            data.currentRelease = version;
            initReleases();
            render();
          }
        } else {
          alert("–†–µ–ª–∏–∑ —Å —Ç–∞–∫–æ–π –≤–µ—Ä—Å–∏–µ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
        }
      }
    });

    // –†–µ–Ω–¥–µ—Ä –¥–æ—Å–∫–∏
    function render(){
      if (!data.currentRelease || !data.releases[data.currentRelease]) {
        els.board.innerHTML = '<div class="no-tasks">No releases found</div>';
        return;
      }
      
      initReleases();
      els.board.innerHTML='';
      
      const currentRelease = data.releases[data.currentRelease];
      const items = currentRelease.items || [];
      
      STATUS_ORDER.forEach(s => {
        const col = document.createElement('div');
        col.className = 'column';
        col.innerHTML = `<div class="col-header">${s.label}</div>`;
        
        const dz = document.createElement('div');
        dz.className = 'dropzone';
        dz.dataset.status = s.id;
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', onDrop);
        
        col.appendChild(dz);
        els.board.appendChild(col);
        
        getItems(s.id, items).forEach(it => dz.appendChild(cardEl(it)));
      });
      
      renderCharts();
      renderReleaseTimeline();
    }

    // –†–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function renderCharts(){
      const currentRelease = data.releases[data.currentRelease];
      const items = currentRelease.items || [];
      
      // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
      const counts = STATUS_ORDER.map(s => 
        items.filter(x => x.status === s.id).length
      );
      
      if(chart) chart.destroy();
      
      const ctx = els.progressChart.getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: STATUS_ORDER.map(s => s.label),
          datasets: [{
            label: '–ó–∞–¥–∞—á–∏',
            data: counts,
            backgroundColor: [
              '#6bc4a4', // Ready to Dev
              '#7aa2ff', // –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
              '#ffd166', // Review/QA
              '#f77f00', // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
              '#9d4edd', // –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–ª–∏–∑—É
              '#2a9d8f'  // Released
            ]
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // –†–µ–Ω–¥–µ—Ä —Ç–∞–π–º–ª–∞–π–Ω–∞ —Ä–µ–ª–∏–∑–∞
    function renderReleaseTimeline(){
      const currentRelease = data.releases[data.currentRelease];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç
      els.releaseDateDisplay.textContent = currentRelease.releaseDate || "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
      els.storeDateDisplay.textContent = currentRelease.storeDate || "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ —Å–æ–±—ã—Ç–∏–π
      const today = new Date();
      today.setHours(0,0,0,0);
      
      if(currentRelease.releaseDate){
        const releaseDate = new Date(currentRelease.releaseDate);
        const diffTime = releaseDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        els.releaseDays.textContent = `${diffDays} –¥–Ω–µ–π`;
        els.releaseDays.className = "milestone-days " + 
          (diffDays > 14 ? "days-normal" : 
           diffDays > 3 ? "days-warning" : "days-critical");
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Ä–µ–ª–∏–∑–∞ (30 –¥–Ω–µ–π = 100%)
        const daysTotal = 30;
        const daysPassed = Math.min(Math.max(0, daysTotal - diffDays), daysTotal);
        els.releaseProgress.style.width = `${(daysPassed / daysTotal) * 100}%`;
      }
      
      if(currentRelease.storeDate){
        const storeDate = new Date(currentRelease.storeDate);
        const diffTime = storeDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        els.storeDays.textContent = `${diffDays} –¥–Ω–µ–π`;
        els.storeDays.className = "milestone-days " + 
          (diffDays > 14 ? "days-normal" : 
           diffDays > 3 ? "days-warning" : "days-critical");
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Store
        const daysTotal = 30;
        const daysPassed = Math.min(Math.max(0, daysTotal - diffDays), daysTotal);
        els.storeProgress.style.width = `${(daysPassed / daysTotal) * 100}%`;
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Å—Ç–∞—Ç—É—Å—É
    function getItems(status, items){
      const q = els.search.value.toLowerCase();
      return items.filter(x => x.status === status).filter(x => {
        const hay = [
          x.title,
          x.description,
          x.assignee,
          x.release,
          (x.tags || []).join(' ')
        ].join(' ').toLowerCase();
        
        return !q || hay.includes(q);
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á–∏
    function cardEl(it){
      const el = document.createElement('div');
      el.className = 'card';
      el.draggable = true;
      el.dataset.id = it.id;
      
      if(/bug/i.test(it.title)) el.classList.add('bug');
      
      el.addEventListener('dragstart', e => {
        el.classList.add('dragging');
        e.dataTransfer.setData('text/plain', it.id);
      });
      
      el.addEventListener('dragend', () => el.classList.remove('dragging'));
      el.addEventListener('click', () => openEditor(it.id));
      
      const prioClass = {
        'Low': 'prio-low',
        'Medium': 'prio-med',
        'High': 'prio-high',
        'Critical': 'prio-critical'
      }[it.priority || 'Low'];
      
      el.innerHTML = `
        <div>
          <span class="priority ${prioClass}"></span>
          <b>${it.title}</b> 
          ${it.link ? `<a href="${it.link}" target="_blank">üîó</a>` : ''}
        </div>
        <div>${it.assignee || ''} | Release: ${it.release || ''}</div>
        ${it.description ? `<div>${it.description}</div>` : ''}
        ${it.tags ? `<div class="tags">${it.tags.map(t => `<span class=tag>${t}</span>`).join('')}</div>` : ''}
      `;
      
      return el;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    async function onDrop(e){
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      const currentRelease = data.releases[data.currentRelease];
      const it = currentRelease.items.find(x => x.id == id);
      
      if(it){
        const newStatus = e.currentTarget.dataset.status;
        it.status = newStatus;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ Supabase
        await supabase
          .from('tasks')
          .update({ status: newStatus })
          .eq('id', id);
        
        render();
      }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
    async function addItem(){
      console.log("Add Item button clicked");
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
      if (!currentUser) {
        alert("Please login first");
        return;
      }
      
      const release = data.releases[data.currentRelease];
      if (!release) {
        alert("Please select a release first");
        return;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { data: { user } } = await supabase.auth.getUser();
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
      const newTask = {
        title: "New Task",
        release_id: release.id,
        status: 'ready',
        assignee: "",
        priority: "Low",
        description: "",
        tags: [],
        user_id: user.id  // –î–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ Supabase
      const { data: createdTask, error } = await supabase
        .from('tasks')
        .insert(newTask)
        .select();
      
      if (error) {
        console.error('Error creating task:', error);
        alert("Error creating task: " + error.message);
        return;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –ª–æ–∫–∞–ª—å–Ω–æ
      if (createdTask && createdTask.length > 0) {
        release.items.push({
          ...createdTask[0],
          release: createdTask[0].release_id
        });
        
        // –û–¢–ö–†–´–í–ê–ï–ú –†–ï–î–ê–ö–¢–û–†
        openEditor(createdTask[0].id);
      }
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∑–∞–¥–∞—á–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
    function openEditor(id){
      console.log("Opening editor for task:", id);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      els.modal.style.display = 'flex';
      
      const currentRelease = data.releases[data.currentRelease];
      if (!currentRelease) return;
      
      const it = currentRelease.items.find(x => x.id == id);
      if (!it) return;
      
      editingId = id;
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
      els.mTitle.value = it.title;
      els.mRelease.value = it.release || data.currentRelease;
      els.mAssignee.value = it.assignee || "";
      els.mPriority.value = it.priority || "Low";
      els.mDescription.value = it.description || "";
      els.mLink.value = it.link || "";
      els.mTags.value = (it.tags || []).join(", ");
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    els.mSave.onclick = async () => {
      const currentRelease = data.releases[data.currentRelease];
      if (!currentRelease) return;
      
      const it = currentRelease.items.find(x => x.id == editingId);
      if (!it) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
      it.title = els.mTitle.value;
      it.assignee = els.mAssignee.value;
      it.priority = els.mPriority.value;
      it.description = els.mDescription.value;
      it.link = els.mLink.value;
      it.tags = els.mTags.value.split(',').map(x => x.trim()).filter(Boolean);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ Supabase
      await supabase
        .from('tasks')
        .update({
          title: it.title,
          assignee: it.assignee,
          priority: it.priority,
          description: it.description,
          link: it.link,
          tags: it.tags
        })
        .eq('id', it.id);
      
      els.modal.style.display = 'none';
      render();
    };

    els.mCancel.onclick = () => {
      els.modal.style.display = 'none';
    };

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    els.exportBtn.addEventListener('click', () => {
      const currentRelease = data.releases[data.currentRelease];
      if (!currentRelease) return;
      
      const items = currentRelease.items || [];
      const rows = [["title","release","status","assignee","priority","link","tags","description"]];
      
      items.forEach(it => 
        rows.push([
          it.title,
          it.release,
          it.status,
          it.assignee || '',
          it.priority || '',
          it.link || '',
          (it.tags || []).join(';'),
          it.description || ''
        ])
      );
      
      const csv = rows.map(r => r.map(v => '"' + (v || '').replace(/"/g, '""') + '"').join(",")).join("\n");
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `release_${data.currentRelease}_plan.csv`;
      a.click();
    });

    // –ò–º–ø–æ—Ä—Ç –∏–∑ CSV
    els.importBtn.addEventListener('click', () => els.importFile.click());
    els.importFile.addEventListener('change', async (e) => {
      if (!e.target.files[0]) return;
      
      const file = e.target.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const currentRelease = data.releases[data.currentRelease];
        if (!currentRelease) return;
        
        const lines = e.target.result.split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) return;
        
        const hdr = lines.shift().split(',').map(x => x.replace(/^"|"$/g, '').trim());
        const items = [];
        
        for (const line of lines) {
          try {
            const cols = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(c => c.replace(/^"|"$/g, ''));
            const obj = {};
            hdr.forEach((h, i) => obj[h] = cols[i] || '');
            obj.tags = (obj.tags || '').split(';').filter(Boolean);
            items.push(obj);
          } catch (e) {
            console.error('Error parsing CSV line:', line);
          }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ —Ç–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑
        for (const item of items) {
          const newTask = {
            title: item.title,
            release_id: currentRelease.id,
            status: item.status || 'ready',
            assignee: item.assignee || '',
            priority: item.priority || 'Low',
            description: item.description || '',
            link: item.link || '',
            tags: item.tags || []
          };
          
          const { data: createdTask, error } = await supabase
            .from('tasks')
            .insert(newTask)
            .select();
          
          if (!error && createdTask && createdTask.length > 0) {
            currentRelease.items.push({
              ...createdTask[0],
              release: createdTask[0].release_id
            });
          }
        }
        
        render();
      };
      
      reader.readAsText(file);
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    els.themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      els.themeBtn.textContent = document.body.classList.contains('light') ? '‚òÄÔ∏è' : 'üåô';
    });
    
    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    els.logoutBtn.addEventListener('click', logout);
    
    // –†–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    function setupRealtime() {
      const channel = supabase
        .channel('tasks')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'tasks'
        }, async (payload) => {
          console.log('Change received:', payload);
          await loadTasks();
          render();
        })
        .subscribe();
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showLoginMessage(`Application error: ${event.error.message}`);
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–°–ï–• –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
      initEventHandlers();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      checkSession();
    });
  })();
  </script>
</body>
</html>
