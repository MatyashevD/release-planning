<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WB Drive Release Plan</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root{
      --bg:#0f1226;
      --panel:#161a36;
      --panel-2:#1b2046;
      --text:#f4f6ff;
      --muted:#c0c6f0;
      --accent:#7aa2ff;
      --bad:#ff5e5e;
      --low:#6bc4a4;
      --med:#ffd166;
      --high:#f77f00;
      --critical:#ef476f;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --large: 18px;
      --xl: 22px;
      --xxl: 28px;
      
      --primary-bg-default: #A73AFD;
      --primary-bg-hovered: #9625FC;
      --primary-bg-pressed: #8500FC;
      --primary-content-default: #FFFFFF;
      --primary-content-disabled: #D1D1E0;
      --primary-bg-disabled: #F6F6F9;
      
      --secondary-content-default: #FFFFFF;
      --secondary-content-disabled: #D1D1E0;
      
      --search-bg-default: #3A3050;
      --search-bg-hover: #463960;
      --search-bg-pressed: #524370;
      --search-text: #B879FC;
    }

    body.light{
      --bg:#f5f7ff;
      --panel:#ffffff;
      --panel-2:#f0f0f8;
      --text:#111;
      --muted:#555;
      --accent:#3366ff;
      
      --primary-bg-default: #A73AFD;
      --primary-bg-hovered: #9625FC;
      --primary-bg-pressed: #8500FC;
      --primary-content-default: #FFFFFF;
      --primary-content-disabled: #D1D1E0;
      --primary-bg-disabled: #F6F6F9;
      
      --secondary-content-default: #111;
      --secondary-content-disabled: #D1D1E0;
      
      --search-bg-default: #F8E7FF;
      --search-bg-hover: #E5C9FF;
      --search-bg-pressed: #D7B2FF;
      --search-text: #A73AFD;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#0b0e20);
      color:var(--text);
      font-family:Inter,system-ui;
      transition:.3s background,.3s color;
      min-height:100vh;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px 18px;
      background:rgba(10,13,34,.8);
      position:sticky;
      top:0;
      z-index:10;
      flex-wrap:wrap;
    }
    body.light .topbar{background:#eaeaff;}
    .app-title{
      font-size:var(--xxl);
      font-weight:800;
      flex:1;
    }
    
    button{
      font-size:var(--large);
      border-radius:8px;
      border:none;
      padding:8px 16px;
      cursor:pointer;
      transition:background 0.2s, transform 0.1s;
    }
    
    button.primary{
      background:var(--primary-bg-default);
      color:var(--primary-content-default);
    }
    
    button.primary:hover{
      background:var(--primary-bg-hovered);
    }
    
    button.primary:active{
      background:var(--primary-bg-pressed);
      transform:translateY(1px);
    }
    
    button.primary:disabled{
      background:var(--primary-bg-disabled);
      color:var(--primary-content-disabled);
      cursor:not-allowed;
    }
    
    button.secondary{
      background:var(--panel-2);
      color:var(--secondary-content-default);
      border:1px solid rgba(255,255,255,.1);
    }
    
    body.light button.secondary{
      border:1px solid #ccc;
    }
    
    button.secondary:disabled{
      color:var(--secondary-content-disabled);
    }
    
    button.danger{
      background:var(--bad);
      color:white;
    }
    
    #search {
      font-size:var(--large);
      border-radius:8px;
      border:1px solid transparent;
      background:var(--search-bg-default);
      color:var(--search-text);
      padding:8px 16px;
      transition:background 0.2s, transform 0.1s;
    }
    
    #search:hover {
      background:var(--search-bg-hover);
    }
    
    #search:focus {
      background:var(--search-bg-pressed);
      outline:none;
      transform:scale(1.01);
    }
    
    #search::placeholder {
      color:rgba(184, 121, 252, 0.7);
    }
    
    body.light #search::placeholder {
      color:rgba(167, 58, 253, 0.7);
    }
    
    select{
      font-size:var(--large);
      border-radius:8px;
      border:1px solid rgba(255,255,255,.1);
      background:var(--panel-2);
      color:var(--text);
      padding:8px 16px;
    }
    
    body.light select{
      border:1px solid #ccc;
    }

    .board{
      display:grid;
      grid-template-columns:repeat(6,minmax(250px,1fr));
      gap:12px;
      padding:12px;
    }
    
    .column{
      background:var(--panel);
      border-radius:var(--radius);
      display:flex;
      flex-direction:column;
      transition:.3s background;
    }
    
    .col-header{
      padding:10px;
      font-weight:700;
      font-size:var(--xl);
      border-bottom:1px solid rgba(255,255,255,.1);
    }

    .dropzone{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:50px;
    }

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:12px 45px 12px 12px;
      cursor:grab;
      transition:.3s background;
      position:relative;
    }
    
    body.light .card {
      border: 1px solid rgba(0,0,0,.1);
    }
    
    .card.dragging{
      opacity:.6;
    }
    
    .priority{
      width:12px;
      height:12px;
      border-radius:50%;
      margin-right:6px;
      display:inline-block;
    }
    
    .prio-low{background:var(--low);} 
    .prio-med{background:var(--med);} 
    .prio-high{background:var(--high);} 
    .prio-critical{background:var(--critical);} 
    
    .bug{
      border:2px solid var(--bad)!important;
    }
    
    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    
    .tag{
      background:rgba(255,255,255,.1);
      border-radius:6px;
      padding:2px 6px;
      font-size:14px;
    }
    
    .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
    }
    
    .card-btn {
      background: rgba(0, 0, 0, 0.3);
      border: none;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      color: white;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .card-btn:hover {
      background: rgba(0, 0, 0, 0.6);
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .card-btn:active {
      transform: scale(0.95);
    }
    
    .card-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .card-title-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .task-title {
      flex: 1;
      word-wrap: break-word;
      line-height: 1.2;
    }
    
    .card-links {
      display: flex;
      gap: 8px;
      margin-top: 2px;
    }
    
    .card-links a {
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .card-links a:hover {
      opacity: 1;
    }

    .footer{
      padding:10px;
      font-size:14px;
      color:var(--muted);
    }
    
    #dashboard{
      background:var(--panel);
      margin:12px;
      border-radius:var(--radius);
      padding:12px;
    }
    
    .dates{
      display:flex;
      gap:20px;
      align-items:center;
    }
    
    #releaseInfo{
      margin-top:8px;
      font-size:15px;
      color:var(--muted);
    }

    .modal{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
      backdrop-filter: blur(15px) brightness(0.7);
    }
    
    .modal-content{
      background:var(--panel-2);
      padding:30px;
      border-radius:12px;
      max-width:500px;
      width:90%;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:15px;
      border: 2px solid rgba(255,255,255,0.3);
      animation: modalAppear 0.3s ease-out;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    @keyframes modalAppear {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-content h3{
      margin:0 0 20px;
      font-size:20px;
      text-align:center;
    }
    
    .release-timeline {
      display:flex;
      gap:20px;
      margin-top:15px;
    }
    
    .release-milestone {
      flex:1;
      background:var(--panel-2);
      border-radius:var(--radius);
      padding:15px;
      position:relative;
    }
    
    .milestone-header {
      font-weight:bold;
      margin-bottom:10px;
      display:flex;
      justify-content:space-between;
    }
    
    .milestone-date {
      font-size:18px;
      margin:5px 0;
    }
    
    .milestone-days {
      font-size:14px;
      margin-top:5px;
      padding:3px 8px;
      border-radius:12px;
      display:inline-block;
    }
    
    .days-normal {background:var(--low);}
    .days-warning {background:var(--high);}
    .days-critical {background:var(--critical);}
    
    .progress-bar {
      height:8px;
      background:rgba(255,255,255,0.1);
      border-radius:4px;
      margin-top:10px;
      overflow:hidden;
    }
    
    .progress-fill {
      height:100%;
      background:var(--primary-bg-default);
      border-radius:4px;
    }
    
    .timeline-connector {
      position:absolute;
      top:40%;
      right:-20px;
      width:20px;
      height:2px;
      background:var(--muted);
    }
    
    .release-chart {
      margin-top:20px;
    }
    
    .chart-container {
      background:var(--panel-2);
      border-radius:var(--radius);
      padding:15px;
      height: 250px;
    }
    
    .chart-title {
      font-weight:bold;
      margin-bottom:10px;
    }
    
    .dates input {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 8px;
      padding: 6px 10px;
    }
    
    body.light .dates input {
      border: 1px solid #ccc;
    }
    
    .release-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .release-name {
      font-weight: bold;
      font-size: 20px;
      margin-right: 10px;
    }
    
    .view-tabs {
      display: flex;
      gap: 10px;
      padding: 10px 20px 0;
      margin-bottom: 15px;
    }
    
    .view-tab {
      padding: 10px 20px;
      background: var(--panel-2);
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .view-tab.active {
      background: var(--panel);
      border-bottom: 3px solid var(--primary-bg-default);
    }
    
    #backlogView {
      display: none;
      padding: 20px;
    }
    
    .release-group {
      background: var(--panel);
      border-radius: var(--radius);
      margin-bottom: 25px;
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .release-actions {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }
    
    .release-btn {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .release-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      margin-bottom: 15px;
      padding-right: 150px;
    }
    
    .release-title {
      font-size: 22px;
      font-weight: bold;
      color: var(--accent);
    }
    
    .release-dates {
      display: flex;
      gap: 20px;
      font-size: 16px;
      color: var(--muted);
    }
    
    .task-item {
      padding: 12px 16px;
      background: var(--panel-2);
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      transition: all 0.3s ease;
      cursor: grab;
      min-height: auto;
      max-height: none;
      overflow: visible;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .task-item:hover {
      background: var(--panel);
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .task-item.updating {
      opacity: 0.7;
      transform: scale(0.98);
      pointer-events: none;
    }
    
    .task-item.dragging {
      opacity: 0.6;
    }
    
    .drop-zone-active {
      background: rgba(122, 162, 255, 0.1);
      border: 2px dashed var(--accent);
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è backlog */
    .task-title-compact {
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .task-meta {
      font-size: 14px;
      color: var(--muted);
      font-weight: normal;
    }
    
    .task-description-compact {
      font-size: 14px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.3;
    }
    
    .tags-compact {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .tag-compact {
      background: rgba(255,255,255,.15);
      border-radius: 6px;
      padding: 3px 8px;
      font-size: 13px;
      color: var(--text);
      font-weight: 500;
    }
    
    .task-link-compact {
      color: var(--accent);
      text-decoration: none;
      font-size: 12px;
    }
    
    .task-link-compact:hover {
      opacity: 0.8;
    }
    
    .task-info {
      flex: 1;
    }
    
    .task-title {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .task-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 15px;
      display: inline-block;
      margin-top: 5px;
    }
    
    .task-link:hover {
      text-decoration: underline;
    }
    
    .task-status {
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 15px;
      font-weight: 500;
      min-width: 140px;
      text-align: center;
    }
    
    .status-selector {
      background: var(--panel);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .status-selector:disabled {
      opacity: 0.7;
      cursor: wait;
    }
    
    .status-ready { background: var(--low); color: #000; }
    .status-dev { background: var(--accent); }
    .status-review { background: var(--med); color: #000; }
    .status-test { background: var(--high); }
    .status-rfr { background: #9d4edd; }
    .status-released { background: #2a9d8f; }
    
    .no-tasks {
      text-align: center;
      padding: 30px;
      font-size: 18px;
      color: var(--muted);
    }
    
    .loader {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid var(--accent);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Light theme modal adjustments */
    body.light .modal {
      backdrop-filter: blur(15px) brightness(1.2);
    }
    
    body.light .modal-content {
      background: var(--panel);
      border: 1px solid rgba(0,0,0,0.1);
    }
    
    /* Login form specific styles */
    #loginForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    #loginForm input {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: var(--panel);
      color: var(--text);
    }
    
    #loginForm .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    
    #loginForm .button-group button {
      flex: 1;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 15px;
    }
    
    .delete-btn {
      background: var(--bad);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .delete-btn:hover {
      background: #ff4444;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .delete-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="app-title">WB Drive Release Plan</div>
    <input id="search" placeholder="Search or filter (title, tag, release)"/>
    
    <div class="release-controls">
      <span class="release-name">Release:</span>
      <select id="filterRelease">
        <option value="">Select Release</option>
      </select>
      <button id="addReleaseBtn" class="primary">+ Add Release</button>
    </div>
    
    <div class="dates">
      üìÖ –ü–ª–∞–Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑: <input type="date" id="releaseDate"/>
      üì¶ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Store: <input type="date" id="storeDate"/>
    </div>
    
    <button id="addBtn" class="primary">+ Add Item</button>
    <button id="exportBtn" class="primary">Export CSV</button>
    <input type="file" id="importFile" style="display:none" accept=".csv"/>
    <button id="importBtn" class="primary">Import CSV</button>
    <button id="themeBtn" class="secondary">üåô</button>
    <button id="logoutBtn" class="secondary" style="display:none;">Logout</button>
  </div>

  <div class="view-tabs">
    <div class="view-tab active" data-view="kanban">Kanban Board</div>
    <div class="view-tab" data-view="backlog">Backlog Update</div>
  </div>

  <div id="kanbanView">
    <div id="dashboard">
      <div class="release-timeline">
        <div class="release-milestone">
          <div class="milestone-header">
            <span>–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Store</span>
            <span class="milestone-days" id="storeDays"></span>
          </div>
          <div class="milestone-date" id="storeDateDisplay"></div>
          <div class="progress-bar">
            <div class="progress-fill" id="storeProgress"></div>
          </div>
        </div>
        
        <div class="release-milestone">
          <div class="milestone-header">
            <span>–ü–ª–∞–Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑</span>
            <span class="milestone-days" id="releaseDays"></span>
          </div>
          <div class="milestone-date" id="releaseDateDisplay"></div>
          <div class="progress-bar">
            <div class="progress-fill" id="releaseProgress"></div>
          </div>
        </div>
      </div>
      
      <div class="release-chart">
        <div class="chart-container">
          <div class="chart-title">–ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ–ª–∏–∑–∞</div>
          <canvas id="progressChart"></canvas>
        </div>
      </div>
      
      <div id="releaseInfo"></div>
    </div>

    <main id="board" class="board"></main>
  </div>

  <div id="backlogView"></div>

  <div class="footer">Drag cards between statuses. Click card to edit. Bugs are highlighted in red.</div>

  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Edit Task</h3>
      <input id="mTitle" placeholder="Title"/>
      <select id="mRelease">
        <option value="">Select Release</option>
      </select>
      <input id="mAssignee" placeholder="Assignee"/>
      <select id="mPriority">
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Critical">Critical</option>
      </select>
      <input id="mLink" placeholder="Link (Jira/Task URL)"/>
      <textarea id="mDescription" placeholder="Description"></textarea>
      <input id="mTags" placeholder="Tags (comma separated)"/>
      <div class="modal-actions">
        <button id="mDelete" class="delete-btn">Delete Task</button>
        <div style="display:flex;gap:10px;">
          <button id="mCancel" class="secondary">Cancel</button>
          <button id="mSave" class="primary">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="loginModal" class="modal" style="display:flex;">
    <div class="modal-content">
      <h3>Login to Release Manager</h3>
      <form id="loginForm">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="Password" required />
        <div class="button-group">
          <button type="button" id="loginBtn" class="primary">Login</button>
          <button type="button" id="signupBtn" class="secondary">Sign Up</button>
        </div>
        <div class="loader" id="loginLoader"></div>
        <div id="loginMessage" style="margin-top:10px;color:var(--bad);text-align:center;"></div>
      </form>
    </div>
  </div>

  <script>
  (function(){
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
    const SUPABASE_URL = "https://nfixznxrpiobbstrqvdw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5maXh6bnhycGlvYmJzdHJxdmR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MjA1MDgsImV4cCI6MjA3MTA5NjUwOH0.bTCzAPdX5mDVl8AtbZeefsSFqlPo7c_zebKimn_mCsY";
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        flowType: 'pkce',
        autoRefreshToken: true,
        detectSessionInUrl: true,
        persistSession: true,
        storage: localStorage
      }
    });
    
    const STATUS_ORDER = [
      {id:'ready', label:'Ready to Dev'},
      {id:'dev', label:'In dev'},
      {id:'review', label:'Ready for QA'},
      {id:'test', label:'In test'},
      {id:'rfr', label:'Ready to release'},
      {id:'released', label:'Released'}
    ];

    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    let data = {
      releases: {},
      currentRelease: ""
    };
    
    let chart;
    let editingId = null;
    let currentUser = null;
    let realtimeChannel = null;

    // –°–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
    const els = {
      board: document.getElementById('board'),
      search: document.getElementById('search'),
      filterRelease: document.getElementById('filterRelease'),
      addBtn: document.getElementById('addBtn'),
      addReleaseBtn: document.getElementById('addReleaseBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      themeBtn: document.getElementById('themeBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      progressChart: document.getElementById('progressChart'),
      releaseDate: document.getElementById('releaseDate'),
      storeDate: document.getElementById('storeDate'),
      releaseInfo: document.getElementById('releaseInfo'),
      modal: document.getElementById('modal'),
      mTitle: document.getElementById('mTitle'),
      mRelease: document.getElementById('mRelease'),
      mAssignee: document.getElementById('mAssignee'),
      mPriority: document.getElementById('mPriority'),
      mDescription: document.getElementById('mDescription'),
      mLink: document.getElementById('mLink'),
      mTags: document.getElementById('mTags'),
      mSave: document.getElementById('mSave'),
      mCancel: document.getElementById('mCancel'),
      mDelete: document.getElementById('mDelete'),
      releaseDateDisplay: document.getElementById('releaseDateDisplay'),
      storeDateDisplay: document.getElementById('storeDateDisplay'),
      releaseDays: document.getElementById('releaseDays'),
      storeDays: document.getElementById('storeDays'),
      releaseProgress: document.getElementById('releaseProgress'),
      storeProgress: document.getElementById('storeProgress'),
      kanbanView: document.getElementById('kanbanView'),
      backlogView: document.getElementById('backlogView'),
      loginModal: document.getElementById('loginModal'),
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      loginBtn: document.getElementById('loginBtn'),
      signupBtn: document.getElementById('signupBtn'),
      loginLoader: document.getElementById('loginLoader'),
      loginMessage: document.getElementById('loginMessage'),
      loginForm: document.getElementById('loginForm')
    };

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    
    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS
    function escapeAttr(value) {
      return String(value).replace(/"/g, '&quot;');
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ DD-MM-YYYY
    function fmtDateDDMMYYYY(dateString) {
      if (!dateString) return 'No date';
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'Invalid date';
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}-${month}-${year}`;
    }
    
    // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
    async function checkSession() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏:', error);
          showLoginMessage('–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏: ' + error.message);
          return;
        }
        
        if (session) {
          console.log('–ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞:', session);
          currentUser = session.user;
          hideLoginModal();
          els.logoutBtn.style.display = 'block';
          await initApp();
        } else {
          console.log('–ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          showLoginModal();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–∏:', error);
        showLoginMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–∏: ' + error.message);
      }
    }

    function showLoginModal() {
      els.loginModal.style.display = 'flex';
    }

    function hideLoginModal() {
      els.loginModal.style.display = 'none';
    }

    function initEventHandlers() {
      // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      if (els.loginBtn) els.loginBtn.addEventListener('click', login);
      if (els.signupBtn) els.signupBtn.addEventListener('click', signup);
      if (els.logoutBtn) els.logoutBtn.addEventListener('click', logout);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
      if (els.loginForm) {
        els.loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          login();
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
      if (els.loginPassword) {
        els.loginPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            login();
          }
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const view = tab.dataset.view;
          switchView(view);
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      if (els.addBtn) els.addBtn.addEventListener('click', addItem);
      if (els.exportBtn) els.exportBtn.addEventListener('click', exportCSV);
      if (els.importBtn) els.importBtn.addEventListener('click', () => els.importFile.click());
      if (els.importFile) els.importFile.addEventListener('change', importCSV);
      if (els.themeBtn) els.themeBtn.addEventListener('click', toggleTheme);
      if (els.mSave) els.mSave.addEventListener('click', saveTask);
      if (els.mCancel) els.mCancel.addEventListener('click', closeModal);
      if (els.mDelete) {
        els.mDelete.addEventListener('click', () => {
          console.log('–ö–Ω–æ–ø–∫–∞ mDelete –Ω–∞–∂–∞—Ç–∞, editingId =', editingId);
          deleteTask();
        });
      } else {
        console.error('–≠–ª–µ–º–µ–Ω—Ç mDelete –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
      
      // Live-–ø–æ–∏—Å–∫
      if (els.search) {
        els.search.addEventListener('input', () => {
          render();
        });
      }
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Esc
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }

    async function login() {
      try {
        toggleLoginLoader(true);
        const email = els.loginEmail.value;
        const password = els.loginPassword.value;
        
        if (!email || !password) {
          showLoginMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
          return;
        }
        
        console.log('–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å:', email);
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
          throw error;
        }
        
        console.log('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω:', data);
        currentUser = data.user;
        hideLoginModal();
        els.logoutBtn.style.display = 'block';
        await initApp();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        showLoginMessage(error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.');
      } finally {
        toggleLoginLoader(false);
      }
    }

    async function signup() {
      try {
        toggleLoginLoader(true);
        const email = els.loginEmail.value;
        const password = els.loginPassword.value;
        
        if (!email || !password) {
          showLoginMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
          return;
        }
        
        console.log('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:', email);
        
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: window.location.href
          }
        });
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
          throw error;
        }
        
        if (data.user) {
          console.log('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', data);
          currentUser = data.user;
          hideLoginModal();
          els.logoutBtn.style.display = 'block';
          await initApp();
          showLoginMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
        } else {
          showLoginMessage('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        showLoginMessage(error.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      } finally {
        toggleLoginLoader(false);
      }
    }

    async function logout() {
      try {
        console.log('–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        await supabase.auth.signOut();
        currentUser = null;
        els.logoutBtn.style.display = 'none';
        showLoginModal();
        data = { releases: {}, currentRelease: "" };
        render();
        showLoginMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
        showLoginMessage('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
      }
    }

    function toggleLoginLoader(show) {
      if (els.loginLoader) {
        els.loginLoader.style.display = show ? 'block' : 'none';
      }
      if (els.loginBtn) {
        els.loginBtn.disabled = show;
      }
      if (els.signupBtn) {
        els.signupBtn.disabled = show;
      }
    }

    function showLoginMessage(message) {
      if (els.loginMessage) {
        els.loginMessage.textContent = message;
        setTimeout(() => { 
          els.loginMessage.textContent = ''; 
        }, 5000);
      }
    }

    // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    async function initApp() {
      console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      try {
        await loadReleases();
        initReleases();
        render();
        setupRealtime();
        
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Kanban
        switchView('kanban');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        showLoginMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + error.message);
      }
    }

    async function loadReleases() {
      console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ª–∏–∑–æ–≤');
      const { data: releases, error } = await supabase
        .from('releases')
        .select('*')
        .order('version', { ascending: false });
      
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–ª–∏–∑–æ–≤:', error);
        return;
      }
      
      data.releases = {};
      if (releases) {
        releases.forEach(release => {
          data.releases[release.version] = {
            id: release.id,
            version: release.version,
            releaseDate: release.release_date,
            storeDate: release.store_date,
            items: []
          };
        });
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ª–∏–∑–æ–≤
      await loadTasks();
      
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–ª–∏–∑–∞
      if (Object.keys(data.releases).length > 0) {
        data.currentRelease = Object.keys(data.releases)[0];
      } else {
        console.log('–†–µ–ª–∏–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      }
    }

    async function loadTasks() {
      console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á');
      const { data: tasks, error } = await supabase
        .from('tasks')
        .select('*');
      
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
        return;
      }
      
      // –°–±—Ä–æ—Å –∑–∞–¥–∞—á
      Object.values(data.releases).forEach(release => {
        release.items = [];
      });
      
      // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ä–µ–ª–∏–∑–∞–º
      if (tasks) {
        tasks.forEach(task => {
          // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–≥–æ–≤
          if (task.tags && !Array.isArray(task.tags)) {
            task.tags = [task.tags];
          } else if (!task.tags) {
            task.tags = [];
          }
          
          const release = Object.values(data.releases).find(r => r.id === task.release_id);
          if (release) {
            release.items.push({
              ...task,
              release: task.release_id,
              releaseVersion: release.version
            });
          } else {
            console.warn('–†–µ–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–∞–¥–∞—á–∏:', task);
          }
        });
      }
    }

    function initReleases() {
      console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ª–∏–∑–æ–≤ –≤ UI');
      els.filterRelease.innerHTML = '<option value="">Select Release</option>';
      els.mRelease.innerHTML = '<option value="">Select Release</option>';
      
      Object.keys(data.releases).forEach(release => {
        // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —Ä–µ–ª–∏–∑–æ–≤
        const option = document.createElement('option');
        option.value = release;
        option.textContent = release;
        if (release === data.currentRelease) {
          option.selected = true;
        }
        els.filterRelease.appendChild(option);
        
        // –î–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–ª–∏–∑–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        const editorOption = document.createElement('option');
        editorOption.value = release;
        editorOption.textContent = release;
        els.mRelease.appendChild(editorOption);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–ª–∏–∑–∞
      const current = data.releases[data.currentRelease];
      if (current) {
        els.releaseDate.value = current.releaseDate || "";
        els.storeDate.value = current.storeDate || "";
      } else {
        console.log('–¢–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∞—Ç
    if (els.releaseDate) {
      els.releaseDate.onchange = async () => {
        const releaseVersion = data.currentRelease;
        const release = data.releases[releaseVersion];
        if (!release) return;
        
        release.releaseDate = els.releaseDate.value;
        
        await supabase
          .from('releases')
          .update({ release_date: release.releaseDate })
          .eq('version', releaseVersion);
        
        render();
      };
    }
    
    if (els.storeDate) {
      els.storeDate.onchange = async () => {
        const releaseVersion = data.currentRelease;
        const release = data.releases[releaseVersion];
        if (!release) return;
        
        release.storeDate = els.storeDate.value;
        
        await supabase
          .from('releases')
          .update({ store_date: release.storeDate })
          .eq('version', releaseVersion);
        
        render();
      };
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ä–µ–ª–∏–∑–∞
    if (els.filterRelease) {
      els.filterRelease.onchange = () => {
        data.currentRelease = els.filterRelease.value;
        render();
      };
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞
    if (els.addReleaseBtn) {
      els.addReleaseBtn.addEventListener('click', async () => {
        const version = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.0):");
        if (version) {
          if (!data.releases[version]) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–∏–∑ –≤ Supabase
            const { data: newRelease, error } = await supabase
              .from('releases')
              .insert({
                version: version,
                release_date: null,
                store_date: null
              })
              .select();
            
            if (error) {
              alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞: " + error.message);
              return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ
            if (newRelease && newRelease.length > 0) {
              data.releases[version] = {
                id: newRelease[0].id,
                version: version,
                releaseDate: null,
                storeDate: null,
                items: []
              };
              
              data.currentRelease = version;
              initReleases();
              render();
            }
          } else {
            alert("–†–µ–ª–∏–∑ —Å —Ç–∞–∫–æ–π –≤–µ—Ä—Å–∏–µ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
          }
        }
      });
    }

    // –†–µ–Ω–¥–µ—Ä –¥–æ—Å–∫–∏
    function render(){
      console.log('–†–µ–Ω–¥–µ—Ä –¥–æ—Å–∫–∏');
      if (!data.currentRelease || !data.releases[data.currentRelease]) {
        els.board.innerHTML = '<div class="no-tasks">–†–µ–ª–∏–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }
      
      initReleases();
      els.board.innerHTML = '';
      
      const currentRelease = data.releases[data.currentRelease];
      const items = currentRelease.items || [];
      
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
      STATUS_ORDER.forEach(s => {
        const col = document.createElement('div');
        col.className = 'column';
        col.innerHTML = `<div class="col-header">${s.label}</div>`;
        
        const dz = document.createElement('div');
        dz.className = 'dropzone';
        dz.dataset.status = s.id;
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', onDrop);
        
        col.appendChild(dz);
        els.board.appendChild(col);
        
        getItems(s.id, items).forEach(it => dz.appendChild(cardEl(it)));
      });
      
      renderCharts();
      renderReleaseTimeline();
    }

    // –†–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function renderCharts(){
      const currentRelease = data.releases[data.currentRelease];
      const items = currentRelease.items || [];
      
      // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
      const counts = STATUS_ORDER.map(s => 
        items.filter(x => x.status === s.id).length
      );
      
      if(chart) chart.destroy();
      
      const ctx = els.progressChart.getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: STATUS_ORDER.map(s => s.label),
          datasets: [{
            label: '–ó–∞–¥–∞—á–∏',
            data: counts,
            backgroundColor: [
              '#6bc4a4', // Ready to Dev
              '#7aa2ff', // –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
              '#ffd166', // Review/QA
              '#f77f00', // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
              '#9d4edd', // –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–ª–∏–∑—É
              '#2a9d8f'  // Released
            ]
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } },
          maintainAspectRatio: false,
          responsive: true
        }
      });
    }

    // –†–µ–Ω–¥–µ—Ä —Ç–∞–π–º–ª–∞–π–Ω–∞ —Ä–µ–ª–∏–∑–∞
    function renderReleaseTimeline(){
      const currentRelease = data.releases[data.currentRelease];
      if (!currentRelease) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç
      els.releaseDateDisplay.textContent = fmtDateDDMMYYYY(currentRelease.releaseDate);
      els.storeDateDisplay.textContent = fmtDateDDMMYYYY(currentRelease.storeDate);
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ —Å–æ–±—ã—Ç–∏–π
      const today = new Date();
      today.setHours(0,0,0,0);
      
      if(currentRelease.releaseDate){
        const releaseDate = new Date(currentRelease.releaseDate);
        const diffTime = releaseDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        els.releaseDays.textContent = `${diffDays} –¥–Ω–µ–π`;
        els.releaseDays.className = "milestone-days " + 
          (diffDays > 14 ? "days-normal" : 
           diffDays > 3 ? "days-warning" : "days-critical");
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Ä–µ–ª–∏–∑–∞ (30 –¥–Ω–µ–π = 100%)
        const daysTotal = 30;
        const daysPassed = Math.min(Math.max(0, daysTotal - diffDays), daysTotal);
        els.releaseProgress.style.width = `${(daysPassed / daysTotal) * 100}%`;
      }
      
      if(currentRelease.storeDate){
        const storeDate = new Date(currentRelease.storeDate);
        const diffTime = storeDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        els.storeDays.textContent = `${diffDays} –¥–Ω–µ–π`;
        els.storeDays.className = "milestone-days " + 
          (diffDays > 14 ? "days-normal" : 
           diffDays > 3 ? "days-warning" : "days-critical");
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Store
        const daysTotal = 30;
        const daysPassed = Math.min(Math.max(0, daysTotal - diffDays), daysTotal);
        els.storeProgress.style.width = `${(daysPassed / daysTotal) * 100}%`;
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Å—Ç–∞—Ç—É—Å—É
    function getItems(status, items){
      const q = els.search.value.toLowerCase();
      return items.filter(x => x.status === status).filter(x => {
        const hay = [
          x.title,
          x.description,
          x.assignee,
          x.releaseVersion,
          (x.tags || []).join(' ')
        ].join(' ').toLowerCase();
        
        return !q || hay.includes(q);
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á–∏
    function cardEl(it){
      const el = document.createElement('div');
      el.className = 'card';
      el.draggable = true;
      el.dataset.id = it.id;
      
      if(/bug/i.test(it.title)) el.classList.add('bug');
      
      el.addEventListener('dragstart', e => {
        el.classList.add('dragging');
        e.dataTransfer.setData('text/plain', JSON.stringify({
          id: it.id,
          releaseId: it.release
        }));
      });
      
      el.addEventListener('dragend', () => el.classList.remove('dragging'));
      el.addEventListener('click', () => openEditor(it.id));
      
      const prioClass = {
        'Low': 'prio-low',
        'Medium': 'prio-med',
        'High': 'prio-high',
        'Critical': 'prio-critical'
      }[it.priority || 'Low'];
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞ –≤–º–µ—Å—Ç–æ ID
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ tags - –º–∞—Å—Å–∏–≤
      const tags = Array.isArray(it.tags) ? it.tags : [];
      
      el.innerHTML = `
        <div class="card-actions">
          <button class="card-btn" onclick="event.stopPropagation(); window.deleteTask('${it.id}')">üóëÔ∏è</button>
        </div>
        <div class="card-content">
          <div class="card-title-row">
            <span class="priority ${prioClass}"></span>
            <b class="task-title">${escapeHtml(it.title)}</b>
          </div>
          <div class="card-links">
            ${it.link ? `<a href="${escapeAttr(it.link)}" target="_blank" onclick="event.stopPropagation()" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">üîó</a>` : ''}
          </div>
        </div>
        <div>${escapeHtml(it.assignee || '')} | Release: ${escapeHtml(it.releaseVersion || 'N/A')}</div>
        ${it.description ? `<div>${escapeHtml(it.description)}</div>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t => `<span class=tag>${escapeHtml(t)}</span>`).join('')}</div>` : ''}
      `;
      
      return el;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    async function onDrop(e){
      e.preventDefault();
      const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
      const id = dragData.id;
      const currentRelease = data.releases[data.currentRelease];
      const it = currentRelease.items.find(x => x.id == id);
      
      if(it){
        const newStatus = e.currentTarget.dataset.status;
        it.status = newStatus;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ Supabase
        await supabase
          .from('tasks')
          .update({ status: newStatus })
          .eq('id', id);
        
        render();
      }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    async function addItem(){
      try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (!user || userError) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É");
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–ª–∏–∑–∞
        if (!data.currentRelease) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ª–∏–∑");
          return;
        }
        
        const release = data.releases[data.currentRelease];
        if (!release) {
          alert("–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω");
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É —Å user_id
        const newTask = {
          title: "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
          release_id: release.id,
          status: 'ready',
          assignee: "",
          priority: "Low",
          description: "",
          link: "",
          tags: [],
          user_id: user.id
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Supabase
        const { data: createdTask, error } = await supabase
          .from('tasks')
          .insert(newTask)
          .select();
        
        if (error) throw error;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –ª–æ–∫–∞–ª—å–Ω–æ —Å –≤–µ—Ä—Å–∏–µ–π —Ä–µ–ª–∏–∑–∞
        release.items.push({
          ...createdTask[0],
          release: createdTask[0].release_id,
          releaseVersion: release.version
        });
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
        openEditor(createdTask[0].id);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏: ${error.message}`);
      }
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∑–∞–¥–∞—á–∏
    function openEditor(id){
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      els.modal.style.display = 'flex';
      
      const currentRelease = data.releases[data.currentRelease];
      if (!currentRelease) return;
      
      // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É –≤–æ –≤—Å–µ—Ö —Ä–µ–ª–∏–∑–∞—Ö
      let it = null;
      for (const version in data.releases) {
        const release = data.releases[version];
        const task = release.items.find(x => x.id == id);
        if (task) {
          it = task;
          break;
        }
      }
      
      if (!it) return;
      
      editingId = id;
      console.log('openEditor: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω editingId =', editingId);
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ tags - –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–¥ join
      const tags = Array.isArray(it.tags) ? it.tags : [];
      
      els.mTitle.value = it.title || "";
      els.mRelease.value = it.releaseVersion || data.currentRelease;
      els.mAssignee.value = it.assignee || "";
      els.mPriority.value = it.priority || "Low";
      els.mDescription.value = it.description || "";
      els.mLink.value = it.link || "";
      els.mTags.value = tags.join(", ");
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function saveTask() {
      try {
        const it = await findTaskById(editingId);
        if (!it) return;
        
        const oldReleaseVersion = it.releaseVersion;
        const newReleaseVersion = els.mRelease.value;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
        it.title = els.mTitle.value;
        it.assignee = els.mAssignee.value;
        it.priority = els.mPriority.value;
        it.description = els.mDescription.value;
        it.link = els.mLink.value;
        it.tags = els.mTags.value.split(',').map(x => x.trim()).filter(Boolean);
        
        // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–µ–ª–∏–∑, –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∑–∞–¥–∞—á—É
        if (oldReleaseVersion !== newReleaseVersion) {
          const oldRelease = data.releases[oldReleaseVersion];
          const newRelease = data.releases[newReleaseVersion];
          
          if (oldRelease && newRelease) {
            // –£–¥–∞–ª—è–µ–º –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–ª–∏–∑–∞
            oldRelease.items = oldRelease.items.filter(x => x.id != editingId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑
            it.release = newRelease.id;
            it.releaseVersion = newReleaseVersion;
            it.release_id = newRelease.id;
            newRelease.items.push(it);
          }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ Supabase
        await supabase
          .from('tasks')
          .update({
            title: it.title,
            assignee: it.assignee,
            priority: it.priority,
            description: it.description,
            link: it.link,
            tags: it.tags,
            release_id: it.release_id
          })
          .eq('id', it.id);
        
        closeModal();
        render();
        if (els.backlogView.style.display === 'block') {
          renderBacklog();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message);
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function deleteTask(id = null) {
      // –ï—Å–ª–∏ id - —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ, –∏–∑–≤–ª–µ–∫–∞–µ–º –µ–≥–æ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞
      let taskId;
      if (id && typeof id === 'object' && id.target) {
        // –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ - –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ
        console.error('deleteTask –ø–æ–ª—É—á–∏–ª —Å–æ–±—ã—Ç–∏–µ –≤–º–µ—Å—Ç–æ ID:', id);
        return;
      } else {
        taskId = id || editingId;
      }
      
      if (!taskId) {
        console.error('deleteTask: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
        return;
      }
      
      console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å ID:', taskId);
      
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
        return;
      }
      
      try {
        // –£–¥–∞–ª—è–µ–º –∏–∑ Supabase
        const { error } = await supabase
          .from('tasks')
          .delete()
          .eq('id', taskId);
        
        if (error) throw error;
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        for (const version in data.releases) {
          const release = data.releases[version];
          release.items = release.items.filter(x => x.id != taskId);
        }
        
        if (id) {
          // –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
          render();
          if (els.backlogView.style.display === 'block') {
            renderBacklog();
          }
        } else {
          // –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
          closeModal();
          render();
          if (els.backlogView.style.display === 'block') {
            renderBacklog();
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message);
      }
    }

    // –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á–∏ –ø–æ ID
    async function findTaskById(id) {
      for (const version in data.releases) {
        const release = data.releases[version];
        const task = release.items.find(x => x.id == id);
        if (task) {
          return task;
        }
      }
      return null;
    }

    function closeModal() {
      els.modal.style.display = 'none';
      editingId = null;
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    async function exportCSV() {
      try {
        const currentRelease = data.releases[data.currentRelease];
        if (!currentRelease) return;
        
        const items = currentRelease.items || [];
        const rows = [["title","release","status","assignee","priority","link","tags","description"]];
        
        items.forEach(it => {
          const tags = Array.isArray(it.tags) ? it.tags.join(';') : '';
          rows.push([
            it.title || '',
            it.releaseVersion || '',
            it.status || '',
            it.assignee || '',
            it.priority || '',
            it.link || '',
            tags,
            it.description || ''
          ]);
        });
        
        const csv = rows.map(r => 
          r.map(v => `"${(v || '').replace(/"/g, '""')}"`).join(",")
        ).join("\n");
        
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `release_${data.currentRelease}_plan.csv`;
        a.click();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
      }
    }

    // –ò–º–ø–æ—Ä—Ç –∏–∑ CSV
    async function importCSV(e) {
      if (!e.target.files[0]) return;
      
      try {
        const file = e.target.files[0];
        const text = await readFile(file);
        
        const currentRelease = data.releases[data.currentRelease];
        if (!currentRelease) return;
        
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) return;
        
        const header = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
        const items = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          const values = parseCSVLine(line);
          if (values.length !== header.length) continue;
          
          const obj = {};
          header.forEach((key, index) => {
            obj[key] = values[index].replace(/^"|"$/g, '');
          });
          
          // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–≥–æ–≤
          if (obj.tags) {
            obj.tags = obj.tags.split(';').filter(Boolean);
          } else {
            obj.tags = [];
          }
          
          items.push(obj);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ —Ç–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑
        for (const item of items) {
          const newTask = {
            title: item.title,
            release_id: currentRelease.id,
            status: item.status || 'ready',
            assignee: item.assignee || '',
            priority: item.priority || 'Low',
            description: item.description || '',
            link: item.link || '',
            tags: item.tags || []
          };
          
          const { data: createdTask, error } = await supabase
            .from('tasks')
            .insert(newTask)
            .select();
          
          if (!error && createdTask && createdTask.length > 0) {
            currentRelease.items.push({
              ...createdTask[0],
              release: createdTask[0].release_id,
              releaseVersion: currentRelease.version
            });
          }
        }
        
        render();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
      } finally {
        // –°–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏—è input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
        els.importFile.value = '';
      }
    }

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      values.push(current);
      return values;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    function toggleTheme() {
      document.body.classList.toggle('light');
      els.themeBtn.textContent = document.body.classList.contains('light') ? '‚òÄÔ∏è' : 'üåô';
    }
    
    // –†–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    function setupRealtime() {
      // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (realtimeChannel) {
        supabase.removeChannel(realtimeChannel);
      }
      
      realtimeChannel = supabase
        .channel('tasks')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'tasks'
        }, async (payload) => {
          console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', payload);
          await loadTasks();
          render();
          
          // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –±—ç–∫–ª–æ–≥, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ–≥–æ —Ç–æ–∂–µ
          if (els.backlogView.style.display === 'block') {
            renderBacklog();
          }
        })
        .subscribe();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º–∏
    function switchView(viewName) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === viewName);
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
      els.kanbanView.style.display = viewName === 'kanban' ? 'block' : 'none';
      els.backlogView.style.display = viewName === 'backlog' ? 'block' : 'none';
      
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–ª–æ–≥–∞ - —Ä–µ–Ω–¥–µ—Ä–∏–º –µ–≥–æ
      if (viewName === 'backlog') {
        renderBacklog();
      }
    }

    // –†–µ–Ω–¥–µ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –±—ç–∫–ª–æ–≥–∞
    async function renderBacklog() {
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
      await loadReleases();
      
      els.backlogView.innerHTML = '';
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–ª–∏–∑—ã –ø–æ –≤–µ—Ä—Å–∏–∏ (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
      const sortedReleases = Object.values(data.releases).sort((a, b) => {
        return b.version.localeCompare(a.version);
      });
      
      sortedReleases.forEach(release => {
        const releaseGroup = document.createElement('div');
        releaseGroup.className = 'release-group';
        releaseGroup.dataset.release = release.version;
        
        releaseGroup.innerHTML = `
          <div class="release-header">
            <div class="release-title">Release ${release.version}</div>
            <div class="release-dates">
              <span>üìÖ ${fmtDateDDMMYYYY(release.releaseDate)}</span>
              <span>üì¶ ${fmtDateDDMMYYYY(release.storeDate)}</span>
            </div>
          </div>
          <div class="release-actions">
            <button class="release-btn primary" onclick="renameRelease('${release.version}')">Rename</button>
            <button class="release-btn danger" onclick="deleteRelease('${release.version}')">Delete</button>
          </div>
          <div class="tasks-list"></div>
        `;
        
        const tasksList = releaseGroup.querySelector('.tasks-list');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏
        (release.items || []).forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.className = 'task-item';
          taskItem.dataset.id = task.id;
          taskItem.draggable = true;
          
          // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ tags - –º–∞—Å—Å–∏–≤
          const tags = Array.isArray(task.tags) ? task.tags : [];
          
          taskItem.innerHTML = `
            <div class="task-info">
              <div class="task-title-compact">
                <strong>${escapeHtml(task.title)}</strong>
                <span class="task-meta"> ‚Ä¢ ${escapeHtml(task.assignee || 'Unassigned')} ‚Ä¢ ${release.version}</span>
                ${task.link ? ` ‚Ä¢ <a href="${escapeAttr(task.link)}" class="task-link-compact" target="_blank" onclick="event.stopPropagation()">üîó</a>` : ''}
              </div>
              ${task.description ? `<div class="task-description-compact">${escapeHtml(task.description.substring(0, 100))}${task.description.length > 100 ? '...' : ''}</div>` : ''}
              ${tags.length ? `
                <div class="tags-compact">
                  ${tags.slice(0, 3).map(tag => `<span class="tag-compact">${escapeHtml(tag)}</span>`).join('')}
                  ${tags.length > 3 ? `<span class="tag-compact">+${tags.length - 3}</span>` : ''}
                </div>
              ` : ''}
            </div>
            <div class="task-status">
              <select class="status-selector" data-id="${task.id}">
                ${STATUS_ORDER.map(s => 
                  `<option value="${s.id}" ${task.status === s.id ? 'selected' : ''}>${s.label}</option>`
                ).join('')}
              </select>
            </div>
          `;
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è drag & drop
          taskItem.addEventListener('dragstart', (e) => {
            taskItem.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify({
              id: task.id,
              releaseId: task.release
            }));
          });
          
          taskItem.addEventListener('dragend', () => {
            taskItem.classList.remove('dragging');
          });
          
          tasksList.appendChild(taskItem);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–æ–Ω—ã –¥—Ä–æ–ø–∞
        tasksList.addEventListener('dragover', (e) => {
          e.preventDefault();
          tasksList.classList.add('drop-zone-active');
        });
        
        tasksList.addEventListener('dragleave', () => {
          tasksList.classList.remove('drop-zone-active');
        });
        
        tasksList.addEventListener('drop', async (e) => {
          e.preventDefault();
          tasksList.classList.remove('drop-zone-active');
          
          const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
          const taskId = dragData.id;
          const oldReleaseId = dragData.releaseId;
          
          // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É
          let task = null;
          let oldRelease = null;
          
          for (const version in data.releases) {
            const r = data.releases[version];
            if (r.id === oldReleaseId) {
              oldRelease = r;
              task = r.items.find(x => x.id == taskId);
              break;
            }
          }
          
          if (!task || !oldRelease) return;
          
          // –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–ª–∏–∑–∞
          oldRelease.items = oldRelease.items.filter(x => x.id != taskId);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑
          task.release = release.id;
          task.release_id = release.id;
          task.releaseVersion = release.version;
          release.items.push(task);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
          await supabase
            .from('tasks')
            .update({ release_id: release.id })
            .eq('id', taskId);
          
          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–±–µ –≤—å—é—Ö–∏
          render();
          renderBacklog();
        });
        
        // –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç
        if (!release.items || release.items.length === 0) {
          tasksList.innerHTML = '<div class="no-tasks">No tasks for this release</div>';
        }
        
        els.backlogView.appendChild(releaseGroup);
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ —Å—Ç–∞—Ç—É—Å–∞
      document.querySelectorAll('.status-selector').forEach(select => {
        select.addEventListener('change', async function() {
          const taskId = this.dataset.id;
          const newStatus = this.value;
          
          // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          let found = false;
          for (const version in data.releases) {
            const release = data.releases[version];
            const taskIndex = release.items.findIndex(t => t.id == taskId);
            if (taskIndex !== -1) {
              release.items[taskIndex].status = newStatus;
              found = true;
              break;
            }
          }
          
          if (!found) {
            console.error('Task not found');
            return;
          }
          
          // –í–∏–∑—É–∞–ª—å–Ω–æ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ"
          const taskItem = this.closest('.task-item');
          taskItem.classList.add('updating');
          this.disabled = true;
          
          try {
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const { error } = await supabase
              .from('tasks')
              .update({ status: newStatus })
              .eq('id', taskId);
            
            if (error) {
              alert('Update error: ' + error.message);
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
              await loadTasks();
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–±–µ –≤—å—é—Ö–∏
            render();
          } catch (error) {
            console.error('Error updating task:', error);
            alert('Error updating task: ' + error.message);
          } finally {
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±—ç–∫–ª–æ–≥
            renderBacklog();
          }
        });
      });
    }

    // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
    async function renameRelease(version) {
      const newVersion = prompt('Enter new release version:', version);
      if (!newVersion || newVersion === version) return;
      
      if (data.releases[newVersion]) {
        alert('Release with this version already exists!');
        return;
      }
      
      try {
        const release = data.releases[version];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
        const { error } = await supabase
          .from('releases')
          .update({ version: newVersion })
          .eq('id', release.id);
        
        if (error) throw error;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        data.releases[newVersion] = {
          ...release,
          version: newVersion
        };
        
        delete data.releases[version];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏
        for (const task of release.items) {
          task.releaseVersion = newVersion;
          
          await supabase
            .from('tasks')
            .update({ release_version: newVersion })
            .eq('id', task.id);
        }
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        initReleases();
        render();
        renderBacklog();
      } catch (error) {
        console.error('Error renaming release:', error);
        alert('Error renaming release: ' + error.message);
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
    async function deleteRelease(version) {
      if (!confirm(`Are you sure you want to delete release ${version}? All tasks will be deleted too.`)) {
        return;
      }
      
      try {
        const release = data.releases[version];
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —Ä–µ–ª–∏–∑–∞
        for (const task of release.items) {
          await supabase
            .from('tasks')
            .delete()
            .eq('id', task.id);
        }
        
        // –£–¥–∞–ª—è–µ–º —Å–∞–º —Ä–µ–ª–∏–∑
        const { error } = await supabase
          .from('releases')
          .delete()
          .eq('id', release.id);
        
        if (error) throw error;
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        delete data.releases[version];
        
        // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑
        if (Object.keys(data.releases).length > 0) {
          data.currentRelease = Object.keys(data.releases)[0];
        } else {
          data.currentRelease = "";
        }
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        initReleases();
        render();
        renderBacklog();
      } catch (error) {
        console.error('Error deleting release:', error);
        alert('Error deleting release: ' + error.message);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
      initEventHandlers();
      checkSession();
    });
    
    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –≤ HTML
    window.deleteTask = deleteTask;
    window.renameRelease = renameRelease;
    window.deleteRelease = deleteRelease;
  })();
  </script>
</body>
</html>
